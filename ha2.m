%% First we generate input data
birthdate = 20030509;    % Write the birth date on format yyyymmdd for oldest member in the group
format compact
[lambdavec,Tvec,cvec] = getSPOdata(birthdate);   %yyyymmdd  Do not use clear command or change the values of these variables

% -------------------------------------------------------------------------------------------------------------------
%% Marginal Allocation
% Question 1 should be answered in the report

cvec = cvec'; % transpose to column vector to use standard notation
svec = zeros(size(lambdavec))';

fs = f(svec, lambdavec, Tvec);
fs2 = f(svec + 10*ones(size(svec)), lambdavec, Tvec)
gs = g(svec, cvec);

%is_integer_convex(f, svec, lambdavec, Tvec)

%Calculate forward differences



%one_vector = 10*ones(size(svec));
%s_plus_1 = svec + one_vector;
%delta_f = f(s_plus_1, lambdavec, Tvec) - f(svec, lambdavec, Tvec)

for j = 1 : length(svec)
    iteration = 0;
    max_iterations = 10000; % Set a limit to avoid infinite loops
    while true
        delta_f_next = f(svec(j+1), lambdavec, Tvec);
        delta_f_curr = f(svec(j), lambdavec, Tvec);
        if delta_f_next < delta_f_curr
            disp("f is not integer-convex")
            break
        end
        iteration = iteration + 1;
        if iteration >= max_iterations
            disp("f is integer-convex for all points up to " + num2str( max_iterations) + ")")
            break
       
        end
    end
end
% Question 2 should described in the report, and submitted below
% Enter on the format EBO2 is total EBO after adding the spare part 
% Cost2 should be the cost of the added spare part
EBO2 = "to do";    
Cost2 = "to do";    %

Q2 = [EBO2 Cost2]; % Checking both at the same time in grader.

% Question 3, you should describe how the Marginal allocation is
% implemented in your own words in the report, and compute all efficient
% points.

% Question 4 should be answered in the report, with a figure and a table with
% all efficient points
% Furthermore, a table with first five efficient points should be submitted below
 
% Enter on the format EPtable = [ x0 EBO(x0) C(x0); x1 EB0(x1) C(x1); ... x4 EBO(x4) C(x4)]
% Where xj is the row vector with number of spare parts of each kind
% corresponding to the efficient points generated by the Marginal allocation algorithm
% EBO and C are the total values (scalars) for each allocation xj
EPtable = "to do";

function output = g(s, c)
    output = c' * s;
end

function output = poissonPMF(k, mu)
    % Beräkna Poisson-PMF utan Statistics Toolbox
    % k kan vara en vektor
    output = exp(-mu) .* (mu.^k) ./ factorial(k);
end

function output = f(s, lambda, T)       % f(s) = EBO(s) = SUM{EBO_j(s_j)} för i = 1 till n
    my = lambda .* T;
    F=0; EBO_j = 0; k = 0; epsilon = 1e-10; SUM_fs = zeros(size(s)); EBO = zeros(size(s));
    for j = 1 : length(s)
        while F < 1 - epsilon
            EBO_j = EBO_j + max(k - s(j), 0) * poissonPMF(k, my(j));
            F = F + poissonPMF(k, my(j));
            k = k + 1;
        end
        EBO(j) = EBO_j;
        SUM_fs(j) = SUM_fs(j) + EBO_j;
        EBO_j = 0; F = 0; k = 0;
    end
    fs = SUM_fs;

    output = fs;
end

function output = is_integer_convex(f, s, lambdavec, Tvec)
    delta_f = zeros(size(s));
    for i = 1 : length(s)
        delta_f(i) = f(s(i) + 1, lambdavec, Tvec) - f(s(i), lambdavec, Tvec);
    end

    for i = 1 : length(delta_f) - 1
        if delta_f(i+1) < delta_f(i)
            output = false;
            return;
        end
    end
    output = true;
end